properties(
  [parameters(
    [
    string(name: 'version' , defaultValue: '', description: '', trim: true),
    [$class: 'com.wangyin.parameter.WHideParameterDefinition', defaultValue: '', description: 'pipeline only - do not use', name: 'profile'],
    ]
  )]
)

node("builder") {

    stage ('Configure') {
         SDK_VERSION= params.version
         print "SDK_VERSION version is ${SDK_VERSION}"
    }

    stage('Tag version as latest') {
        deleteDir()
        withCredentials([string(credentialsId: 'NPM_SDK', variable: 'Secret')]) {
            checkout poll: false, scm: [$class: 'GitSCM', branches: [[name: "${SDK_VERSION}"]], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'LocalBranch'], [$class: 'CheckoutOption'], [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'cswci-gen', url: 'git@github-chf01.synamedia.com:hyperscale/hs-sdk.git']]]
            withDockerContainer("node:16.13.1-buster") {
                sh '''
                npm i
                npm config set @Synamedia:registry https://npm.pkg.github.com
                npm config set -- //npm.pkg.github.com/:_authToken $Secret

                '''
                sh "npm dist-tag rm @Synamedia/hs-sdk@${SDK_VERSION} alpha"
                sh "npm dist-tag add @Synamedia/hs-sdk@${SDK_VERSION} latest"
                SDK_VERSION = sh(returnStdout: true, script: "node -p \"require('./package.json').version\"").trim()
            }
            print "SDK_VERSION is ${SDK_VERSION}"
        }
    }

    stage('Merge hs-webui-tester with SDK version into master') {
        deleteDir()
        checkout poll: false, scm: [$class: 'GitSCM', branches: [[name:"master"]], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'LocalBranch', localBranch:'master'], [$class: 'CheckoutOption'], [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'cswci-gen', url: 'git@github-chf01.synamedia.com:hyperscale/hs-webui-tester.git']]]
        withDockerContainer("node:16.13.1-buster") {
            sh "npm i @Synamedia/hs-sdk@${SDK_VERSION}"
        }
        sshagent(['cswci-gen']) {
            sh '''
                git add .
                git commit -m "update sdk to latest version"
                git push origin master
            '''
        }
    }
}
