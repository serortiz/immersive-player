properties(
    [parameters(
        [
            string(name: 'version' , defaultValue: '', description: '', trim: true),
            [$class: 'HyperscaleEnvironmentParameterDefinition', defaultValue: 'hyperscale', description: '', name: 'environment'],
        ]
    )]
)

node("builder") {

    def WEBUI_BUCKET="hyperscale-webui"

    stage("install new sdk version in hs-webui-tester") {
        deleteDir()
        checkout poll: false, scm: [$class: 'GitSCM', branches: [[name:"master"]], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'LocalBranch', localBranch:'master'], [$class: 'CheckoutOption'], [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'cswci-gen', url: 'git@github-chf01.synamedia.com:hyperscale/hs-webui-tester.git']]]
        withDockerContainer("node:16.13.1-buster") {
            sh "npm i @Synamedia/hs-sdk@${params.version}"
        }
    }

    stage("build hs-webui-tester") {
        withDockerContainer("node:16.13.1-buster") {
            sh "PUBLIC_URL=/hs-webui-tester-testing-sdk npm run build"
        }
    }

	withAWS(credentials:"aws-all", region:"eu-west-1") {
	    stage("Upload hs-webui-tester to S3") {
            s3Upload(bucket:WEBUI_BUCKET, acl:"PublicRead", cacheControl:"max-age=10", path:"hs-webui-tester-testing-sdk", file:"build")
	    }
	}
}
